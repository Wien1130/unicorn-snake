<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>–†–æ–∑–æ–≤–∞—è –ó–º–µ–π–∫–∞ ü¶Ñüë∏üßö</title>
<style>
  :root{
    --pink-1:#ffe6f4;
    --pink-2:#ffb3df;
    --pink-3:#ff6fc4;
    --pink-4:#ff3fae;
    --rose:#ff8ec7;
    --magenta:#d11ea7;
    --accent:#ffd166;
    --dark:#6b1e53;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 800px at 20% 0%, var(--pink-1), transparent 60%),
    radial-gradient(1200px 800px at 80% 100%, var(--pink-2), transparent 60%),
    linear-gradient(180deg, #fff0f7, #ffd9ef 60%, #ffc4e7);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;
    color: var(--dark);
  }
  .wrap{max-width:900px;margin:0 auto;padding:16px; display:flex; flex-direction:column; gap:12px}
  header{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    background: linear-gradient(135deg, #fff, #ffe3f4);
    border:2px solid var(--pink-3); border-radius:16px; padding:10px 12px;
    box-shadow: 0 8px 24px rgba(255, 105, 180, .25);
  }
  .title{display:flex;align-items:center;gap:10px;font-weight:800}
  .title .badge{
    background:linear-gradient(135deg, var(--pink-3), var(--pink-4));
    color:white; padding:6px 10px; border-radius:999px; font-size:12px; letter-spacing:.3px
  }
  .stats{display:flex; gap:16px; align-items:center; flex-wrap:wrap}
  .stat{
    background:#fff; border:2px solid var(--pink-2); border-radius:12px; padding:6px 10px; min-width:84px; text-align:center
  }
  .controls{
    display:flex; gap:8px; flex-wrap:wrap; align-items:center
  }
  button{
    border:none; border-radius:12px; padding:10px 14px; font-weight:700;
    background:linear-gradient(135deg, #fff, #ffe6f4); color:var(--dark);
    border:2px solid var(--pink-3); cursor:pointer;
    box-shadow: 0 6px 16px rgba(255, 105, 180, .25);
    transition: transform .05s ease;
  }
  button:active{ transform: translateY(1px) }
  #gamePanel{
    background:linear-gradient(180deg, #fff, #ffeaf6);
    border:3px solid var(--pink-4); border-radius:18px; padding:10px;
    box-shadow: 0 16px 40px rgba(209, 30, 167, .2);
  }
  #canvasWrap{position:relative}
  canvas{display:block; width:100%; height:auto; background:
    radial-gradient(1000px 600px at 30% 20%, #fff6fb, #ffe6f4 60%),
    repeating-linear-gradient(45deg, #ffdff1, #ffdff1 10px, #ffe9f6 10px, #ffe9f6 20px);
    border-radius:12px; border:2px solid var(--pink-2);
  }

  /* –≠–∫—Ä–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ */
  .pad{
    margin-top:10px; display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; user-select:none
  }
  .pad .empty{visibility:hidden}
  .pad button{padding:14px 0; font-size:18px}
  .legend{
    font-size:12px; opacity:.8; text-align:center
  }

  @media (min-width:720px){
    .pad{display:none}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <div style="font-size:22px">ü¶Ñ –†–æ–∑–æ–≤–∞—è –ó–º–µ–π–∫–∞</div>
        <div class="badge">Princess & Fairy Edition</div>
      </div>
      <div class="stats">
        <div class="stat">–°—á—ë—Ç: <span id="score">0</span></div>
        <div class="stat">–†–µ–∫–æ—Ä–¥: <span id="high">0</span></div>
        <div class="stat">–°–∫–æ—Ä–æ—Å—Ç—å: <span id="spd">1.0x</span></div>
      </div>
      <div class="controls">
        <button id="btnPause">‚è∏ –ü–∞—É–∑–∞</button>
        <button id="btnNew">üÜï –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
      </div>
    </header>

    <div id="gamePanel">
      <div id="canvasWrap">
        <canvas id="game" width="600" height="600" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ"></canvas>
      </div>
      <div class="legend">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: —Å—Ç—Ä–µ–ª–∫–∏ / WASD ‚Ä¢ –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ ‚Äî —Å–≤–∞–π–ø—ã –∏–ª–∏ –∫–Ω–æ–ø–∫–∏</div>

      <div class="pad" aria-label="–≠–∫—Ä–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏">
        <div class="empty"></div>
        <button data-dir="up">‚¨ÜÔ∏è</button>
        <div class="empty"></div>
        <button data-dir="left">‚¨ÖÔ∏è</button>
        <button data-dir="down">‚¨áÔ∏è</button>
        <button data-dir="right">‚û°Ô∏è</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã =====
  const GRID = 20;                 // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è—á–µ–µ–∫ –ø–æ –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ (GRID x GRID)
  const BASE_SPEED_MS = 160;       // –±–∞–∑–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª —à–∞–≥–∞
  const MIN_SPEED_MS = 90;         // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
  const SPEED_STEP_MS = 6;         // —É—Å–∫–æ—Ä–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–µ–¥–∞–Ω–∏–∏
  const COLORS = {
    snakeBody: "#ff8fcf",
    snakeHead: "#ff3fae",
    snakeStroke: "#d11ea7",
    boardBorder: "#ffb3df"
  };
  const PICKUPS = [
    { type: "unicorn", emoji: "ü¶Ñ", score: 1, grow: 1, weight: 75, speedDelta: -SPEED_STEP_MS },
    { type: "princess", emoji: "üë∏", score: 5, grow: 2, weight: 15, speedDelta: -SPEED_STEP_MS*2 },
    { type: "fairy",    emoji: "üßö", score: 3, grow: 1, weight: 10, speedMultiplier: 0.8, effectMs: 6000 }
  ];

  // ===== –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ =====
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  const scoreEl = document.getElementById("score");
  const highEl = document.getElementById("high");
  const spdEl = document.getElementById("spd");
  const btnPause = document.getElementById("btnPause");
  const btnNew = document.getElementById("btnNew");
  const dpad = document.querySelectorAll(".pad button[data-dir]");

  let cell;                 // —Ä–∞–∑–º–µ—Ä —è—á–µ–π–∫–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
  let snake;                // –º–∞—Å—Å–∏–≤ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ [{x,y}, ...]
  let dir;                  // –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ {x,y}
  let pendingDir;           // –æ—á–µ—Ä–µ–¥—å –Ω–∞ —Å–º–µ–Ω—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω—ã–π —Ö–æ–¥)
  let food;                 // —Ç–µ–∫—É—â–∏–π –æ–±—ä–µ–∫—Ç –µ–¥—ã {x,y, item}
  let score;
  let high = Number(localStorage.getItem("unicorn_snake_high") || 0);
  let intervalMs;           // —Ç–µ–∫—É—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —à–∞–≥–∞
  let timer = null;
  let paused = false;
  let speedMul = 1.0;       // –º–Ω–æ–∂–∏—Ç–µ–ª—å —Å–∫–æ—Ä–æ—Å—Ç–∏ (—Ñ–µ—è)
  let speedMulTimeout = null;

  highEl.textContent = high;

  // ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =====
  function fitCanvas() {
    const wrap = document.getElementById("canvasWrap");
    const size = Math.min(wrap.clientWidth, Math.max(320, window.innerHeight - 280));
    canvas.width = size;
    canvas.height = size;
    cell = Math.floor(size / GRID);
  }
  window.addEventListener("resize", () => {
    const oldCell = cell;
    fitCanvas();
    if (oldCell) draw(); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏
  });
  fitCanvas();

  function newGame() {
    stopLoop();
    score = 0;
    intervalMs = BASE_SPEED_MS;
    speedMul = 1.0;
    clearTimeout(speedMulTimeout);
    speedMulTimeout = null;
    scoreEl.textContent = score;
    updateSpeedLabel();

    const startX = Math.floor(GRID/2);
    const startY = Math.floor(GRID/2);
    snake = [{x:startX, y:startY}, {x:startX-1, y:startY}, {x:startX-2, y:startY}];
    dir = {x:1, y:0};
    pendingDir = null;
    food = spawnFood();

    paused = false;
    btnPause.textContent = "‚è∏ –ü–∞—É–∑–∞";
    startLoop();
    draw();
  }

  // ===== –¶–∏–∫–ª –∏–≥—Ä—ã =====
  function startLoop() {
    timer = setInterval(step, Math.max(30, intervalMs*speedMul));
  }
  function stopLoop() {
    if (timer) clearInterval(timer);
    timer = null;
  }
  function restartLoopForSpeed() {
    if (!paused) {
      stopLoop();
      startLoop();
    }
  }

  function step() {
    // –ø—Ä–∏–º–µ–Ω—è–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—É—é —Å–º–µ–Ω—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å
    if (pendingDir) {
      dir = pendingDir;
      pendingDir = null;
    }
    const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };

    // —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å–æ —Å—Ç–µ–Ω–∞–º–∏
    if (head.x < 0 || head.x >= GRID || head.y < 0 || head.y >= GRID) {
      gameOver();
      return;
    }
    // —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å —Å–æ–±–æ–π
    if (snake.some(seg => seg.x === head.x && seg.y === head.y)) {
      gameOver();
      return;
    }

    snake.unshift(head);
    let grow = 0;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–µ–¥–∞–Ω–∏—è
    if (food && head.x === food.x && head.y === food.y) {
      const item = food.item;
      score += item.score;
      scoreEl.textContent = score;

      // —ç—Ñ—Ñ–µ–∫—Ç—ã
      grow += item.grow || 0;
      if (item.speedDelta) {
        intervalMs = Math.max(MIN_SPEED_MS, intervalMs + item.speedDelta);
        updateSpeedLabel();
        restartLoopForSpeed();
      }
      if (item.speedMultiplier) {
        speedMul = Math.max(0.6, (speedMul * item.speedMultiplier));
        updateSpeedLabel();
        restartLoopForSpeed();
        clearTimeout(speedMulTimeout);
        speedMulTimeout = setTimeout(() => {
          speedMul = 1.0;
          updateSpeedLabel();
          restartLoopForSpeed();
        }, item.effectMs || 5000);
      }

      confetti(head);
      food = spawnFood();
    }

    // –µ—Å–ª–∏ –Ω–µ —Ä–∞—Å—Ç—ë–º ‚Äî —É–±–∏—Ä–∞–µ–º —Ö–≤–æ—Å—Ç
    if (grow === 0) {
      snake.pop();
    } else {
      // —Ä–∞—Å—Ç—ë–º –Ω–∞ N: –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º N —à–∞–≥–æ–≤ ‚Äî —É–∂–µ –≤—ã—Ä–æ—Å–ª–∏, —Ç.–∫. –Ω–µ —É–±—Ä–∞–ª–∏ —Ö–≤–æ—Å—Ç
      for (let i=1; i<grow; i++) snake.unshift({x: head.x, y: head.y}); // –±—ã—Å—Ç—Ä–æ–µ "–º–∞–≥–∏—á–µ—Å–∫–æ–µ" –Ω–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ
    }

    draw();
  }

  function gameOver() {
    stopLoop();
    // —Ä–µ–∫–æ—Ä–¥
    if (score > high) {
      high = score;
      localStorage.setItem("unicorn_snake_high", String(high));
      highEl.textContent = high;
    }
    // –Ω–∞–¥–ø–∏—Å—å
    draw(true);
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É ¬´–ù–æ–≤–∞—è –∏–≥—Ä–∞¬ª
  }

  // ===== –†–µ–Ω–¥–µ—Ä =====
  function draw(isGameOver=false) {
    const size = cell;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // —Ä–∞–º–∫–∞
    ctx.save();
    ctx.lineWidth = 2;
    ctx.strokeStyle = COLORS.boardBorder;
    ctx.strokeRect(1,1,GRID*size-2,GRID*size-2);
    ctx.restore();

    // –µ–¥–∞ (—ç–º–æ–¥–∑–∏)
    if (food) {
      const cx = food.x*size + size/2;
      const cy = food.y*size + size*0.75; // —á—É—Ç—å –Ω–∏–∂–µ —Ü–µ–Ω—Ç—Ä–∞ ‚Äî —ç–º–æ–¥–∑–∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ
      ctx.font = `${Math.floor(size*0.9)}px system-ui, Apple Color Emoji, Segoe UI Emoji`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(food.item.emoji, cx, cy);
    }

    // –∑–º–µ–π–∫–∞
    // —Ç–µ–ª–æ
    for (let i=snake.length-1; i>=1; i--){
      const s = snake[i];
      roundRect(ctx, s.x*size+2, s.y*size+2, size-4, size-4, 6);
      const grad = ctx.createLinearGradient(0, s.y*size, 0, s.y*size+size);
      grad.addColorStop(0, "#ffd3ec");
      grad.addColorStop(1, COLORS.snakeBody);
      ctx.fillStyle = grad;
      ctx.strokeStyle = COLORS.snakeStroke;
      ctx.lineWidth = 2;
      ctx.fill();
      ctx.stroke();
    }
    // –≥–æ–ª–æ–≤–∞
    if (snake.length>0){
      const h = snake[0];
      roundRect(ctx, h.x*size+2, h.y*size+2, size-4, size-4, 8);
      ctx.fillStyle = COLORS.snakeHead;
      ctx.strokeStyle = COLORS.snakeStroke;
      ctx.lineWidth = 2.5;
      ctx.fill();
      ctx.stroke();

      // –≥–ª–∞–∑–∫–∏
      const eyeR = Math.max(2, Math.floor(size*0.08));
      const leftEye = { x: h.x*size + size*0.35, y: h.y*size + size*0.35 };
      const rightEye= { x: h.x*size + size*0.65, y: h.y*size + size*0.35 };
      ctx.beginPath(); ctx.arc(leftEye.x,leftEye.y,eyeR,0,Math.PI*2); ctx.fillStyle="#fff"; ctx.fill();
      ctx.beginPath(); ctx.arc(rightEye.x,rightEye.y,eyeR,0,Math.PI*2); ctx.fill();

      const pupilR = Math.max(1.5, eyeR*0.6);
      ctx.beginPath(); ctx.arc(leftEye.x,leftEye.y,pupilR,0,Math.PI*2); ctx.fillStyle="#2b1733"; ctx.fill();
      ctx.beginPath(); ctx.arc(rightEye.x,rightEye.y,pupilR,0,Math.PI*2); ctx.fill();

      // –∫–æ—Ä–æ–Ω–∞ –ø—Ä–∏–Ω—Ü–µ—Å—Å—ã üëë
      ctx.save();
      ctx.fillStyle = "#ffd166";
      ctx.strokeStyle = "#b8860b";
      ctx.lineWidth = 1.5;
      const crownX = h.x*size + size*0.25;
      const crownY = h.y*size + size*0.05;
      ctx.beginPath();
      ctx.moveTo(crownX, crownY + size*0.22);
      ctx.lineTo(crownX + size*0.12, crownY);
      ctx.lineTo(crownX + size*0.24, crownY + size*0.22);
      ctx.lineTo(crownX + size*0.36, crownY);
      ctx.lineTo(crownX + size*0.48, crownY + size*0.22);
      ctx.lineTo(crownX + size*0.60, crownY);
      ctx.lineTo(crownX + size*0.72, crownY + size*0.22);
      ctx.lineTo(crownX + size*0.72, crownY + size*0.28);
      ctx.lineTo(crownX, crownY + size*0.28);
      ctx.closePath();
      ctx.fill(); ctx.stroke();
      ctx.restore();
    }

    if (isGameOver) {
      ctx.save();
      const overlay = "rgba(255,255,255,.8)";
      ctx.fillStyle = overlay;
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#d11ea7";
      ctx.textAlign="center";
      ctx.textBaseline="middle";
      ctx.font = `700 ${Math.floor(canvas.width*0.06)}px system-ui`;
      ctx.fillText("–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê", canvas.width/2, canvas.height/2 - 20);
      ctx.fillStyle = "#6b1e53";
      ctx.font = `500 ${Math.floor(canvas.width*0.035)}px system-ui`;
      ctx.fillText(`–°—á—ë—Ç: ${score}  ‚Ä¢  –†–µ–∫–æ—Ä–¥: ${high}`, canvas.width/2, canvas.height/2 + 16);
      ctx.font = `500 ${Math.floor(canvas.width*0.03)}px system-ui`;
      ctx.fillText("–ù–∞–∂–º–∏ ¬´–ù–æ–≤–∞—è –∏–≥—Ä–∞¬ª –∏–ª–∏ –∫–ª–∞–≤–∏—à—É R", canvas.width/2, canvas.height/2 + 48);
      ctx.restore();
    }
  }

  function roundRect(ctx, x,y,w,h,r) {
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  // –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ –ø—Ä–∏ –ø–æ–µ–¥–∞–Ω–∏–∏
  function confetti(cellPos){
    const size = cell;
    const cx = cellPos.x*size + size/2;
    const cy = cellPos.y*size + size/2;
    const pieces = 10;
    let t = 0;
    const maxT = 14;
    const anim = () => {
      if (t>maxT) return;
      draw(); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Ñ–æ–Ω/–∑–º–µ–π–∫—É
      for (let i=0;i<pieces;i++){
        const ang = (Math.PI*2/pieces)*i + t*0.12;
        const dist = t*2.2;
        const px = cx + Math.cos(ang)*dist;
        const py = cy + Math.sin(ang)*dist;
        ctx.beginPath();
        ctx.arc(px,py,2.2,0,Math.PI*2);
        ctx.fillStyle = (i%2===0) ? "#ff6fc4" : "#ffd166";
        ctx.fill();
      }
      t++;
      requestAnimationFrame(anim);
    };
    requestAnimationFrame(anim);
  }

  // ===== –õ–æ–≥–∏–∫–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è –µ–¥—ã =====
  function spawnFood(){
    // –≤—ã–±–∏—Ä–∞–µ–º —Å–≤–æ–±–æ–¥–Ω—É—é –∫–ª–µ—Ç–∫—É
    const occupied = new Set(snake.map(s => s.x + "," + s.y));
    let pos;
    do {
      pos = { x: Math.floor(Math.random()*GRID), y: Math.floor(Math.random()*GRID) };
    } while (occupied.has(pos.x+","+pos.y));

    // –≤—ã–±–∏—Ä–∞–µ–º –ø—Ä–µ–¥–º–µ—Ç –ø–æ –≤–µ—Å–∞–º
    const item = weightedPick(PICKUPS);
    return { x: pos.x, y: pos.y, item };
  }

  function weightedPick(arr){
    const total = arr.reduce((s,a)=>s+a.weight, 0);
    let r = Math.random()*total;
    for (const a of arr){
      if ((r -= a.weight) <= 0) return a;
    }
    return arr[arr.length-1];
  }

  // ===== –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ =====
  function setDirection(nx, ny) {
    // –∑–∞–ø—Ä–µ—Ç –Ω–∞ —Ä–∞–∑–≤–æ—Ä–æ—Ç –Ω–∞ 180¬∞
    if ( (nx === -dir.x && ny === -dir.y) ) return;
    // –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Äî –∏–≥–Ω–æ—Ä
    if (pendingDir) return;
    pendingDir = {x:nx, y:ny};
  }

  document.addEventListener("keydown", (e)=>{
    const k = e.key.toLowerCase();
    if (k === "arrowup" || k === "w") setDirection(0, -1);
    else if (k === "arrowdown" || k === "s") setDirection(0, 1);
    else if (k === "arrowleft" || k === "a") setDirection(-1, 0);
    else if (k === "arrowright" || k === "d") setDirection(1, 0);
    else if (k === " "){ togglePause(); }
    else if (k === "r"){ newGame(); }
  });

  // –°–≤–∞–π–ø—ã
  let touchStart = null;
  canvas.addEventListener("touchstart", (e)=>{
    if (e.touches.length===1){
      touchStart = {x:e.touches[0].clientX, y:e.touches[0].clientY, t: Date.now()};
    }
  }, {passive:true});
  canvas.addEventListener("touchend", (e)=>{
    if (!touchStart) return;
    const t = Date.now() - touchStart.t;
    const touch = (e.changedTouches && e.changedTouches[0]) || null;
    if (!touch) return;
    const dx = (touch.clientX - touchStart.x);
    const dy = (touch.clientY - touchStart.y);
    const absx = Math.abs(dx), absy = Math.abs(dy);
    const minDist = 24; // –ø–∏–∫—Å–µ–ª–µ–π
    if (t < 800 && (absx>minDist || absy>minDist)){
      if (absx > absy){
        setDirection(dx>0 ? 1 : -1, 0);
      } else {
        setDirection(0, dy>0 ? 1 : -1);
      }
    } else {
      // –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–∞–ø ‚Äî –ø–∞—É–∑–∞
      togglePause();
    }
    touchStart = null;
  }, {passive:true});

  // D-Pad
  dpad.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const d = btn.getAttribute("data-dir");
      if (d==="up") setDirection(0,-1);
      if (d==="down") setDirection(0,1);
      if (d==="left") setDirection(-1,0);
      if (d==="right") setDirection(1,0);
    });
  });

  btnPause.addEventListener("click", togglePause);
  btnNew.addEventListener("click", newGame);

  function togglePause(){
    paused = !paused;
    if (paused){
      stopLoop();
      btnPause.textContent = "‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å";
      // –∑–∞—Ç–µ–º–Ω—è–µ–º
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,.6)";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "#6b1e53";
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.font = `700 ${Math.floor(canvas.width*0.05)}px system-ui`;
      ctx.fillText("–ü–∞—É–∑–∞", canvas.width/2, canvas.height/2);
      ctx.restore();
    } else {
      btnPause.textContent = "‚è∏ –ü–∞—É–∑–∞";
      restartLoopForSpeed();
      draw();
    }
  }

  function updateSpeedLabel(){
    const eff = BASE_SPEED_MS / Math.max(30, intervalMs) * speedMul;
    spdEl.textContent = (eff).toFixed(2) + "x";
  }

  // –ó–∞–ø—É—Å–∫
  newGame();

})();
</script>
</body>
</html>
